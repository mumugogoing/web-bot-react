# Stacks 待处理交易监控系统

## 概述

本系统实现了对 Stacks 区块链指定地址的实时待处理交易监控，支持毫秒级轮询、自动提交、参数验证、重复预防等功能。

## 功能特性

### 1. 实时监控
- **毫秒级轮询**：支持 100ms、200ms、500ms、1000ms、2000ms 可配置间隔
- **指定地址监控**：输入任意 Stacks 地址进行监控
- **自动检测**：实时检测待处理交易并记录日志

### 2. 自动提交
- **后端触发机制**：当后端返回 `singper: true` 时，立即触发交易提交
- **防攻击保护**：提交一次后自动关闭监控，防止被批量交易攻击
- **可选开关**：支持手动开启/关闭自动提交功能

### 3. 智能验证
在提交交易前验证所有必需参数：
- **amount**：交易金额，必须为正数
- **dx**：输入代币合约地址，不能为空
- **dy**：输出代币合约地址，不能为空
- **fee**：交易费率，必须为非负数
- **quote**：报价，必须为正数

### 4. 重复预防
- **3秒冷却期**：每次提交后有 3 秒冷却时间，防止重复提交
- **交易ID追踪**：记录已提交的交易ID，避免重复提交同一交易
- **冷却状态显示**：实时显示剩余冷却时间

### 5. 活动日志
- **最近10条记录**：自动保留最近 10 条监控事件
- **时间戳精度**：毫秒级时间戳显示（HH:mm:ss.SSS）
- **日志类型**：
  - `INFO`：常规信息（蓝色）
  - `SUCCESS`：成功操作（绿色）
  - `WARNING`：警告信息（橙色）
  - `ERROR`：错误信息（红色）
- **可滚动查看**：支持滚动查看历史日志
- **一键清空**：支持清空所有日志

### 6. 速率限制处理
- **自动检测**：识别 429 速率限制错误
- **自动暂停**：遇到速率限制自动停止监控
- **超时重试**：请求超时自动重试，不影响监控

## 使用指南

### 访问路径
登录系统后，通过以下路径访问：
```
导航菜单 -> Stacks -> 待处理监控
或直接访问: /stacks/pending
```

### 配置步骤

#### 1. 基础配置
1. **输入监控地址**：在"监控地址"输入框中输入要监控的 Stacks 地址
2. **选择轮询间隔**：
   - `100ms (极快)`：最高频率，适合抢单场景，可能触发速率限制
   - `200ms (很快)`：高频率监控
   - `500ms (快速)`：推荐使用，平衡速度和稳定性
   - `1000ms (标准)`：标准频率
   - `2000ms (慢速)`：低频率，适合长期监控

3. **配置自动提交**：
   - 开启：检测到 `singper: true` 时自动提交交易并关闭监控
   - 关闭：仅记录待处理交易，需要手动提交

#### 2. 交易参数配置
在"交易参数配置"区域填写：
- **金额 (amount)**：交易数量
- **DX**：输入代币的合约地址（例如：`SM1793C4R5PZ4NS4VQ4WMP7SKKYVH8JZEWSZ9HCCR.token-stx-v-1-2`）
- **DY**：输出代币的合约地址（例如：`SP3Y2ZSH8P7D50B0VBTSX11S7XSG24M1VB9YFQA4K.token-aeusdc`）
- **费率 (fee)**：交易费率（例如：`0.124251`）
- **报价 (quote)**：最小获取数量

#### 3. 启动监控
点击"开始监控"按钮，系统将：
1. 验证监控地址是否填写
2. 验证轮询间隔是否合法（>= 100ms）
3. 立即执行一次检查
4. 按设定间隔持续轮询

#### 4. 查看日志
在"活动日志"区域可以看到：
- 监控启动/停止事件
- 待处理交易检测记录
- 交易提交状态
- 错误和警告信息

### 使用场景

#### 场景1：自动抢单（推荐）
1. 配置好交易参数
2. 选择 `500ms` 轮询间隔
3. 开启"自动提交"开关
4. 点击"开始监控"
5. 系统检测到 `singper: true` 后自动提交并停止

#### 场景2：手动监控
1. 配置监控地址
2. 关闭"自动提交"开关
3. 点击"开始监控"
4. 观察日志中的待处理交易
5. 根据需要点击"手动提交交易"

#### 场景3：测试模式
1. 选择 `2000ms` 低频率
2. 关闭"自动提交"
3. 监控地址活动
4. 分析交易模式

## API 接口

### 1. 监控待处理交易
```typescript
GET /dex/monitor/pending
参数: { address: string }
返回: {
  txid?: string,
  amount?: string | number,
  dx?: string,
  dy?: string,
  fee?: string,
  quote?: string,
  singper?: boolean  // true 表示后端确认可以立即广播
}
```

### 2. xykserialize 交易提交
```typescript
POST /dex/xykserialize
参数: {
  amount: string | number,
  dx: string,
  dy: string,
  fee: string,
  quote: string
}
返回: {
  txid: string,
  status: string
}
```

## 安全机制

### 1. 防重复提交
- 记录已提交的交易ID
- 3秒冷却期强制等待
- 检测相同交易ID并跳过

### 2. 防批量攻击
- 自动提交完成后立即关闭监控
- 避免连续提交多笔交易
- 需要手动重新启动监控

### 3. 速率限制保护
- 自动检测 429 错误
- 立即停止监控避免封禁
- 超时自动重试机制

### 4. 参数验证
- 提交前验证所有参数
- 防止无效交易提交
- 详细的错误提示

## 后端集成

### 后端实现要点
后端需要实现以下功能：

1. **多线程监控模式**
   - 使用多线程持续监控区块链
   - 检测待处理交易并缓存

2. **singper 标志**
   - 当检测到符合条件的交易时设置 `singper: true`
   - 前端收到后立即触发广播

3. **压单开关**
   - 后端控制是否启用压单功能
   - 支持动态开启/关闭

4. **交易广播**
   - 接收前端提交的交易参数
   - 签名并广播到 Stacks 区块链
   - 返回交易ID和状态

### 数据流程
```
后端监控线程 -> 检测待处理交易 -> 设置 singper: true
                                        ↓
前端轮询 -> 获取 singper 标志 -> 自动提交交易
                                        ↓
后端接收 -> 签名广播 -> 返回结果 -> 前端显示状态
```

## 故障排查

### 问题1：监控无法启动
**原因**：地址未填写或轮询间隔过小
**解决**：检查配置并确保间隔 >= 100ms

### 问题2：频繁触发速率限制
**原因**：轮询间隔过小（如 100ms）
**解决**：调整为 500ms 或更大

### 问题3：交易未自动提交
**原因**：
- 自动提交未开启
- 后端未返回 `singper: true`
- 参数验证失败
**解决**：
1. 检查自动提交开关
2. 确认后端返回数据
3. 查看日志中的错误信息

### 问题4：提交失败
**原因**：参数无效或后端错误
**解决**：
1. 检查所有参数是否填写正确
2. 查看活动日志中的详细错误
3. 确认后端服务正常

## 开发说明

### 文件结构
```
src/
├── api/dex/alex.ts                    # API 接口定义
│   ├── monitorPendingTx()            # 监控待处理交易
│   └── xykSerialize()                # xykserialize 提交
├── views/stacks/PendingMonitor.tsx   # 监控页面组件
├── router/index.tsx                   # 路由配置
└── components/Navigation.tsx          # 导航菜单
```

### 核心状态
```typescript
interface PendingTransaction {
  txid?: string;
  amount?: string | number;
  dx?: string;
  dy?: string;
  fee?: string;
  quote?: string;
  singper?: boolean;  // 后端触发标志
}

interface LogItem {
  id: number;
  timestamp: string;
  type: 'info' | 'success' | 'error' | 'warning';
  message: string;
}
```

### 关键函数
- `checkPendingTransactions()`: 轮询检查待处理交易
- `submitTransaction()`: 提交交易到后端
- `validateTxParams()`: 验证交易参数
- `isInCooldown()`: 检查是否在冷却期
- `addLog()`: 添加活动日志

## 性能优化建议

1. **轮询间隔**：推荐使用 500ms，平衡速度和稳定性
2. **日志数量**：仅保留 10 条，避免内存占用
3. **错误处理**：超时自动重试，速率限制自动停止
4. **资源清理**：组件卸载时自动清理定时器

## 未来改进

1. **WebSocket支持**：使用 WebSocket 替代轮询，实时性更好
2. **多地址监控**：同时监控多个地址
3. **交易历史**：记录所有提交的交易历史
4. **统计数据**：显示成功率、平均响应时间等
5. **通知功能**：检测到交易时发送桌面通知
6. **策略配置**：支持更复杂的监控和提交策略

## 权限要求

- 需要管理员权限（`UserRole.ADMIN`）才能访问
- 后端需要正确配置私钥用于交易签名
- 确保后端 API 地址正确配置

## 相关文档

- [Stacks 区块链文档](https://docs.stacks.co/)
- [ALEX DEX 文档](https://docs.alexlab.co/)
- [后端 API 文档](../../../gin-web-dev/README.md)
- [交易监控实现](../STACKS_TRADING_IMPLEMENTATION.md)
